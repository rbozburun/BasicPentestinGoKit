package actions

import (
	"fmt"
	"log"
	"os"
	"time"

	"github.com/urfave/cli"
)

func Commands() {
	app := &cli.App{
		Flags: []cli.Flag{
			cli.StringFlag{Name: "target", Usage: "target web url"},
			cli.BoolFlag{Name: "all", Usage: "Run all security checks."},
			cli.BoolFlag{Name: "crossdomainxml", Usage: "Check crossdomain.xml usage."},
			cli.BoolFlag{Name: "dirlisting", Usage: "Check directory listing is enabled."},
			cli.BoolFlag{Name: "loginpagefinder", Usage: "Check the target URL is login page or not."},
			cli.BoolFlag{Name: "tracedetector", Usage: "Check the target URL is allow TRACE method."},
			cli.BoolFlag{Name: "serverdetector", Usage: "Check the target URL's used webserver."},
			cli.BoolFlag{Name: "xframeoptions", Usage: "Check the target URL's has an X-Frame-Options header or not."},
			cli.BoolFlag{Name: "hsts", Usage: "Check the target URL's has an Strict-Transport-Security header or not."},
		},

		Action: func(c *cli.Context) error {
			if c.String("target") != "" {
				target := c.String("target")

				// TO DO
				// All security checks will be running on parallel
				//
				if c.Bool("all") {
					go CrossdomainFlag(target)
					time.Sleep(time.Second)
					go DirListing(target)
					time.Sleep(time.Second)
					go LoginPageFinder(target)
					time.Sleep(time.Second)
					go TraceDetector(target)
					time.Sleep(time.Second)
					go ServerDetector(target)
					time.Sleep(time.Second)
					go XFrameOptionsHeader(target)
					time.Sleep(time.Second)
					go HSTS(target)
					time.Sleep(time.Second)

				}

				if c.Bool("crossdomainxml") {
					CrossdomainFlag(target)
				}

				if c.Bool("dirlisting") {
					DirListing(target)
				}

				if c.Bool("loginpagefinder") {
					LoginPageFinder(target)
				}

				if c.Bool("tracedetector") {
					TraceDetector(target)
				}

				if c.Bool("serverdetector") {
					ServerDetector(target)
				}

				if c.Bool("xframeoptions") {
					XFrameOptionsHeader(target)
				}

				if c.Bool("hsts") {
					HSTS(target)
				}

			} else {
				fmt.Println("Target cannot be empty!")
			}

			return nil
		},
	}

	err := app.Run(os.Args)
	if err != nil {
		log.Fatal(err)
	}
}
